# Marginalia - Real-Time Shared Notes

A real-time collaborative Markdown notes application built with TanStack Start, Convex, and Tailwind CSS + DaisyUI.

## Features

- **Real-time Collaboration**: Edit notes simultaneously with other users
- **Markdown Support**: Write in Markdown, view rendered HTML
- **Inline Comments**: Add comments anchored to specific text ranges
- **Sharing & Permissions**: Share notes with specific users or make them public
- **Activity Log**: Track all changes and events per note
- **Presence Indicators**: See who's currently viewing/editing a note

## Tech Stack

- **Frontend**: TanStack Start (React + TypeScript)
- **Backend**: Convex (Database + Real-time + Auth)
- **Styling**: Tailwind CSS + DaisyUI
- **Markdown**: react-markdown + remark-gfm

## Getting Started

### Prerequisites

- Node.js 18+
- pnpm
- A Convex account (free tier available)

### Installation

1. Clone the repository
2. Install dependencies:
   ```bash
   pnpm install
   ```

3. Set up Convex:
   ```bash
   npx convex dev
   ```
   This will:
   - Create a new Convex project (if needed)
   - Generate the Convex URL
   - Set up the database schema

4. Configure environment variables:
   - Copy `.env.example` to `.env`
   - Add your Convex URL from the Convex dashboard

5. Start the development server:
   ```bash
   pnpm dev
   ```

6. Open [http://localhost:3000](http://localhost:3000)

## Project Structure

```
marginalia/
├── convex/           # Convex backend functions
│   ├── schema.ts     # Database schema
│   ├── notes.ts      # Note operations
│   ├── comments.ts   # Comment operations
│   ├── permissions.ts # Permission management
│   └── ...
├── src/
│   ├── routes/       # TanStack Router routes
│   ├── components/   # React components
│   └── lib/          # Utilities
└── ...
```

## Development

- `pnpm dev` - Start development server
- `pnpm build` - Build for production
- `pnpm preview` - Preview production build
- `pnpm lint` - Run ESLint
- `pnpm format` - Format code with Prettier

## Deployment

### Netlify Deployment

This project is configured for Netlify deployment using TanStack Start with the `@netlify/vite-plugin-tanstack-start` plugin.

#### Prerequisites

- A Netlify account (free tier available)
- A Convex project set up and deployed
- Your Convex deployment URL

#### Step-by-Step Deployment

1. **Push your code to a Git repository** (GitHub, GitLab, or Bitbucket)

2. **Connect to Netlify**:
   - Go to [Netlify Dashboard](https://app.netlify.com)
   - Click "Add new site" → "Import an existing project"
   - Connect your Git repository
   - Netlify will auto-detect the build settings from `netlify.toml`

3. **Configure Environment Variables**:
   - In Netlify dashboard, go to: **Site settings** → **Build & deploy** → **Environment variables**
   - Add the following variable:
     - **Key**: `VITE_CONVEX_URL`
     - **Value**: Your Convex deployment URL (e.g., `https://your-project.convex.cloud`)
     - **Scopes**: Select "All scopes" or at least "Production" and "Deploy previews"
   
   To get your Convex URL:
   - Go to your [Convex Dashboard](https://dashboard.convex.dev)
   - Select your project
   - Copy the deployment URL from the project settings

4. **Build Settings** (should be auto-detected):
   - **Build command**: `pnpm build`
   - **Publish directory**: `dist/client`
   - **Package manager**: `pnpm`
   - **Node version**: 20 (specified in `.nvmrc`)

5. **Deploy**:
   - Click "Deploy site" (or push to your main branch if auto-deploy is enabled)
   - Netlify will install dependencies, build the project, and deploy

#### Build Output

The build process generates:
- **Client bundle**: `dist/client/` - Static assets and client-side code
- **Server functions**: Automatically generated by `@netlify/vite-plugin-tanstack-start` for SSR support

The `dist/client` directory contains all files needed for deployment, including:
- HTML files
- JavaScript bundles
- CSS files
- Static assets from `public/`

#### Branch Deploys & Preview Deploys

- **Branch deploys**: Automatically created for non-main branches
- **Deploy previews**: Created for pull requests
- Environment variables can be scoped to specific contexts (production, branch deploys, deploy previews)

#### Troubleshooting

**Build fails with "Command not found: pnpm"**:
- Ensure `pnpm` is available in Netlify's build environment
- Netlify should auto-detect pnpm from `package.json`, but you can also add `pnpm` installation step in build command if needed

**Convex connection errors**:
- Verify `VITE_CONVEX_URL` is set correctly in Netlify environment variables
- Ensure the Convex URL includes the full protocol (https://)
- Check that your Convex project is deployed and accessible

**404 errors on routes**:
- The `@netlify/vite-plugin-tanstack-start` plugin automatically handles routing
- If you see 404s, verify the plugin is properly configured in `vite.config.ts`

**Build output not found**:
- Verify the build completes successfully
- Check that `dist/client` directory exists after build
- Ensure `publish = "dist/client"` is set in `netlify.toml`

#### Local Testing

Test your Netlify build locally:

```bash
# Install Netlify CLI (if not already installed)
npm install -g netlify-cli

# Build the project
pnpm build

# Test with Netlify Dev (simulates production environment)
netlify dev
```

This will:
- Use your local `.env` file for environment variables
- Simulate the Netlify build environment
- Test SSR and routing locally

## Notes

- Authentication is currently a placeholder - implement proper Convex Auth setup
- User ID handling needs to be connected to actual authentication
- Presence tracking uses a simplified approach - can be enhanced with Convex's built-in presence API

## License

MIT
